<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>docker-ce-安装</title>
    <url>/jk.io/2020/05/15/docker-ce-%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<p>1、卸载docker旧版本相关<br> <a id="more"></a><br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum remove docker docker-client  docker-client-latest docker-common docker-latest \</span><br><span class="line">docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux  docker-engine</span><br></pre></td></tr></table></figure><br>2、安装新版docker源<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y yum-utils            device-mapper-persistent-data            lvm2</span><br><span class="line">yum-config-manager     --add-repo     https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><br> 3、直接yum安装docker<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install docker-ce</span><br></pre></td></tr></table></figure><br> 启动docker<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><br> 配置下载镜像加速，编辑<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">   <span class="string">"https://dockerhub.azk8s.cn"</span>,</span><br><span class="line">   <span class="string">"https://reg-mirror.qiniu.com"</span></span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br> 刷新配置重启docker<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>redis-主从-哨兵配置</title>
    <url>/jk.io/2020/05/15/redis-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5/</url>
    <content><![CDATA[<p>1、1 Redis官网简介<br>Redis是一个开源（BSD许可），内存存储的数据结构服务器，可用作数据库，高速缓存和消息队列代理。它支持字符串、哈希表、列表、集合、有序集合，位图，hyperloglogs等数据类型。内置复制、Lua脚本、LRU收回、事务以及不同级别磁盘持久化功能，同时通过Redis Sentinel提供高可用，通过Redis Cluster提供自动分区。官网链接：<a href="https://www.redis.net.cn/" target="_blank" rel="noopener">https://www.redis.net.cn/</a></p>
<a id="more"></a>
<p>1、2 Redis作用<br>相信redis这个名称大家都不陌生，为什么？<br>因为redis可以用来做中间插件缓存</p>
<p>1、3 Redis的优、缺点<br>性能极高 – Redis能支持超过 100K+ 每秒的读写频率。<br>丰富的数据类型 – Redis支持二进制案例的 Strings, Lists, Hashes, Sets 及 Ordered Sets 数据类型操作。<br>原子 – Redis的所有操作都是原子性的，同时Redis还支持对几个操作全并后的原子性执行。<br>丰富的特性 – Redis还支持 publish/subscribe, 通知, key 过期等等特性。</p>
<p>Redis的缺点<br>是数据库容量受到物理内存的限制,不能用作海量数据的高性能读写,因此Redis适合的场景主要局限在较小数据量的高性能操作和运算上。</p>
<p>总结： Redis受限于特定的场景，专注于特定的领域之下，速度相当之快，目前还未找到能替代使用产品。</p>
<p>1、4 架构为单机模式：一主多从多哨兵</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">127.0.0.1 redis-master redis(6379)、sentnel(26379)</span><br><span class="line">127.0.0.1 redis-slave  redis(6380)、sentnel(26380)</span><br><span class="line">127.0.0.1 redis-slave  redis(6381)、sentnel(26381)</span><br></pre></td></tr></table></figure>

<p>1、5 Redis下载及安装（脚本形式,只要装一次，然后直接复制配置文件进行修改，多机则都运行一次安装脚本）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim redis_install.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">install_redis</span></span> () &#123;</span><br><span class="line">        <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">        <span class="keyword">if</span> [ ! -f <span class="string">" redis-4.0.1.tar.gz"</span> ]; <span class="keyword">then</span></span><br><span class="line">           wget http://download.redis.io/releases/redis-5.0.4.tar.gz</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">        tar -zxvf /usr/<span class="built_in">local</span>/src/redis-5.0.4.tar.gz</span><br><span class="line">        <span class="built_in">cd</span> redis-5.0.4</span><br><span class="line">        make PREFIX=/usr/<span class="built_in">local</span>/redis install</span><br><span class="line">        mkdir -p /usr/<span class="built_in">local</span>/redis/&#123;etc,var&#125;</span><br><span class="line">        rsync -avz redis.conf  /usr/<span class="built_in">local</span>/redis/etc/</span><br><span class="line">        sed -i <span class="string">"s@logfile.*@logfile /usr/local/redis/var/redis.log@"</span> /usr/<span class="built_in">local</span>/redis/etc/redis.conf  <span class="comment">#相当于替换</span></span><br><span class="line">        sed -i <span class="string">"s@^dir.*@dir /usr/local/redis/var@"</span> /usr/<span class="built_in">local</span>/redis/etc/redis.conf					  <span class="comment">#相当于替换</span></span><br><span class="line">        sed -i <span class="string">'s/daemonize no/daemonize yes/g'</span> /usr/<span class="built_in">local</span>/redis/etc/redis.conf</span><br><span class="line">        sed -i <span class="string">'s/^# bind 127.0.0.1/bind 127.0.0.1/g'</span> /usr/<span class="built_in">local</span>/redis/etc/redis.conf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_redis</span><br></pre></td></tr></table></figure>
<p>1、6 复制配置文件进行对应修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis/etc</span><br><span class="line">sed -i <span class="string">'/^#/d;/^$/d'</span> redis.conf</span><br><span class="line">mv redis.conf redis-6379.conf</span><br><span class="line">cp redis-6379.conf redis-6380.conf</span><br><span class="line">cp redis-6379.conf redis-6381.conf</span><br></pre></td></tr></table></figure>
<p>为了好标记，这里以·开头为修改部分，下面直接粘贴三个配置文件<br>redis-6379.comf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile <span class="string">"/var/run/redis_6379.pid"</span></span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">"/usr/local/redis/var/redis.log"</span></span><br><span class="line">databases 16</span><br><span class="line">always-show-logo yes</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename <span class="string">"dump.rdb"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis/var"</span></span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br></pre></td></tr></table></figure>
<p>redis-6380.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6380</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile <span class="string">"/var/run/redis_6379.pid"</span></span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">"/usr/local/redis/var/redis.log"</span></span><br><span class="line">databases 16</span><br><span class="line">always-show-logo yes</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename <span class="string">"dump.rdb"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis/var"</span></span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">·appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line">·slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>
<p>redis-6381.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">protected-mode yes</span><br><span class="line">·port 6381</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile <span class="string">"/var/run/redis_6379.pid"</span></span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">"/usr/local/redis/var/redis.log"</span></span><br><span class="line">databases 16</span><br><span class="line">always-show-logo yes</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename <span class="string">"dump.rdb"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis/var"</span></span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">·appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line">·slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>
<p>1、7 上面为redis的配置，下面配置三个哨兵（sentinel）,和上面同理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /usr/<span class="built_in">local</span>/redis/data/sentinel</span><br></pre></td></tr></table></figure>
<p>sentinel-6379.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 26379</span><br><span class="line">pidfile <span class="string">"/usr/local/redis/var/redis-6379.pid"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis/data/sentinel"</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">logfile <span class="string">"/usr/local/redis/var/redis-sentinel.log"</span></span><br><span class="line">sentinel monitor redisMaster 127.0.0.1 6379 2 </span><br><span class="line">sentinel down-after-milliseconds redisMaster 10000 </span><br><span class="line">sentinel parallel-syncs redisMaster 1</span><br><span class="line">sentinel failover-timeout redisMaster 60000</span><br></pre></td></tr></table></figure>
<p>sentinel-6380.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 26380</span><br><span class="line">pidfile <span class="string">"/usr/local/redis/var/redis-6380.pid"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis/data/sentinel"</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">logfile <span class="string">"/usr/local/redis/var/redis-sentinel.log"</span></span><br><span class="line">sentinel monitor redisMaster 127.0.0.1 6380 2 </span><br><span class="line">sentinel down-after-milliseconds redisMaster 10000 </span><br><span class="line">sentinel parallel-syncs redisMaster 1</span><br><span class="line">sentinel failover-timeout redisMaster 60000</span><br></pre></td></tr></table></figure>
<p>sentinel-6381.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 26381</span><br><span class="line">pidfile <span class="string">"/usr/local/redis/var/redis-6381.pid"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis/data/sentinel"</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">logfile <span class="string">"/usr/local/redis/var/redis-sentinel.log"</span></span><br><span class="line">sentinel monitor redisMaster 127.0.0.1 6381 2 </span><br><span class="line">sentinel down-after-milliseconds redisMaster 10000 </span><br><span class="line">sentinel parallel-syncs redisMaster 1</span><br><span class="line">sentinel failover-timeout redisMaster 60000</span><br></pre></td></tr></table></figure>
<p>1、8 配置文件现在已经配置完，下面启动服务<br>cd /usr/local/redis/bin</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./redis-server ../etc/redis-6379.conf</span><br><span class="line">./redis-server ../etc/redis-6380.conf</span><br><span class="line">./redis-server ../etc/redis-6381.conf</span><br><span class="line">./redis-sentinel ../data/sentinel/sentinel-6379.conf</span><br><span class="line">./redis-sentinel ../data/sentinel/sentinel-6380.conf</span><br><span class="line">./redis-sentinel ../data/sentinel/sentinel-6381.conf</span><br></pre></td></tr></table></figure>
<p>netstat -ntlp</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@VM_16_2_centos bin]<span class="comment"># netstat -ntlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      19533/./redis-serve </span><br><span class="line">tcp        0      0 0.0.0.0:26379           0.0.0.0:*               LISTEN      18205/./redis-senti </span><br><span class="line">tcp        0      0 0.0.0.0:26380           0.0.0.0:*               LISTEN      18211/./redis-senti </span><br><span class="line">tcp        0      0 127.0.0.1:6380          0.0.0.0:*               LISTEN      17831/./redis-serve </span><br><span class="line">tcp        0      0 127.0.0.1:6381          0.0.0.0:*               LISTEN      2681/./redis-server </span><br><span class="line">tcp        0      0 0.0.0.0:26381           0.0.0.0:*               LISTEN      18227/./redis-senti </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1386/sshd           </span><br><span class="line">tcp6       0      0 :::26379                :::*                    LISTEN      18205/./redis-senti </span><br><span class="line">tcp6       0      0 :::26380                :::*                    LISTEN      18211/./redis-senti </span><br><span class="line">tcp6       0      0 :::26381                :::*                    LISTEN      18227/./redis-senti</span><br></pre></td></tr></table></figure>
<p>1、9 测试，查看自身为什么身份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./redis-cli -h 127.0.0.1 -p 6379 INFO|grep role</span><br><span class="line">role:master</span><br><span class="line">./redis-cli -h 127.0.0.1 -p 6380 INFO|grep role</span><br><span class="line">role:slave</span><br><span class="line">./redis-cli -h 127.0.0.1 -p 6381 INFO|grep role</span><br><span class="line">role:slave</span><br></pre></td></tr></table></figure>
<p>1、10 登陆到master进行写入数据，看slave是否有同步(分别在三个介面操作，方便分别),因我这边已经测试主从切换，master现在为6380</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./redis-cli -h 127.0.0.1 -p 6379 </span><br><span class="line">./redis-cli -h 127.0.0.1 -p 6380 </span><br><span class="line">./redis-cli -h 127.0.0.1 -p 6381</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
</search>
